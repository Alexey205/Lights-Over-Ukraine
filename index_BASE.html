<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lights Over Ukraine</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {
            margin: 0;
            height: 100%;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        .progress-container {
            width: 60px;
            height: 6px;
            background-color: rgba(100, 100, 100, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #4caf50;
        }

        .health-container {
            width: 60px;
            height: 6px;
            background-color: rgba(100, 100, 100, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .health-bar {
            transition: width 0.1s linear;
            height: 100%;
            width: 100%;
            background-color: rgba(244, 67, 54, 0.7);
        }

        .status-working {
            color: green;
        }

        .status-damaged {
            color: red;
        }

        .tooltip-hidden .leaflet-tooltip {
            display: none;
        }

        #teamsStatus {
            font-weight: bold;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #ddd;
        }

        .warning-message {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 87, 34, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-family: sans-serif;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1001;
            animation: fadeOut 3s forwards;
            animation-delay: 1s;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                top: 10px;
            }
        }

        .city-disabled {
            background: radial-gradient(circle, rgba(120,120,120,1) 0%, rgba(120,120,120,0.8) 50%, rgba(120,120,120,0) 100%);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            position: absolute;
            top: -8px;
            left: -8px;
            z-index: -1;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="statusPanel" style="
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 14px;
        border-radius: 10px;
        font-family: sans-serif;
        font-size: 14px;
        box-shadow: 0 0 8px rgba(0,0,0,0.2);
        z-index: 1000;
        line-height: 1.4;
    "></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([48.5, 31], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const cities = {
            'Київ': [50.45, 30.52], 'Львів': [49.84, 24.03], 'Харків': [49.99, 36.23],
            'Одеса': [46.48, 30.73], 'Дніпро': [48.45, 34.98], 'Запоріжжя': [47.84, 35.14],
            'Луцьк': [50.75, 25.33], 'Івано-Франківськ': [48.92, 24.71], 'Тернопіль': [49.55, 25.59],
            'Рівне': [50.62, 26.25], 'Чернівці': [48.29, 25.94], 'Вінниця': [49.23, 28.48],
            'Житомир': [50.25, 28.66], 'Полтава': [49.59, 34.55], 'Кропивницький': [48.51, 32.26],
            'Миколаїв': [46.97, 31.99], 'Херсон': [46.63, 32.6], 'Чернігів': [51.5, 31.3],
            'Суми': [50.92, 34.78], 'Ужгород': [48.62, 22.3], 'Черкаси': [49.44, 32.06],
            'Хмельницький': [49.42, 27.0], 'Краматорськ': [48.74, 37.58], 'Маріуполь': [47.1, 37.55],
            'Сімферополь': [44.95, 34.1], 'Севастополь': [44.61, 33.53],
            'Мелітополь': [46.85, 35.37], 'Луганськ': [48.57, 39.32], 'Керч': [45.35, 36.47],
            'Нікополь': [47.57, 34.4], 'Біла Церква': [49.8, 30.12], 'Кременчук': [49.07, 33.42],
            'Кривий Ріг': [47.91, 33.39]
        };

        const powerStations = [
            { name: 'Бурштинська ТЕС', coords: [49.26, 24.63], type: 'ТЕС' },
            { name: 'Південноукраїнська АЕС', coords: [47.82, 31.18], type: 'АЕС' },
            { name: 'Хмельницька АЕС', coords: [50.37, 26.64], type: 'АЕС' },
            { name: 'Київська ГЕС', coords: [50.58, 30.5], type: 'ГЕС' },
            { name: 'Запорізька АЕС', coords: [47.51, 34.58], type: 'АЕС' },
            { name: 'Трипільська ТЕС', coords: [50.13, 30.79], type: 'ТЕС' },
            { name: 'Криворізька ТЕС', coords: [47.98, 33.38], type: 'ТЕС' },
            { name: 'Кременчуцька ГЕС', coords: [49.10, 33.42], type: 'ГЕС' }
        ];

        const connections = [
            ['Київ', 'Житомир'], ['Житомир', 'Рівне'], ['Рівне', 'Луцьк'], ['Луцьк', 'Львів'],
            ['Київ', 'Чернігів'], ['Київ', 'Черкаси'], ['Київ', 'Полтава'], ['Київ', 'Трипільська ТЕС'],
            ['Полтава', 'Харків'], ['Полтава', 'Краматорськ'], ['Краматорськ', 'Маріуполь'],
            ['Краматорськ', 'Дніпро'], ['Дніпро', 'Запоріжжя'], ['Дніпро', 'Криворізька ТЕС'],
            ['Дніпро', 'Кропивницький'], ['Кропивницький', 'Черкаси'], ['Кропивницький', 'Миколаїв'],
            ['Миколаїв', 'Одеса'], ['Миколаїв', 'Херсон'], ['Херсон', 'Сімферополь'],
            ['Сімферополь', 'Севастополь'], ['Вінниця', 'Київ'], ['Вінниця', 'Хмельницький'],
            ['Хмельницький', 'Тернопіль'], ['Тернопіль', 'Івано-Франківськ'],
            ['Івано-Франківськ', 'Чернівці'], ['Ужгород', 'Івано-Франківськ'],
            ['Суми', 'Харків'], ['Суми', 'Чернігів'],
            ['Південноукраїнська АЕС', 'Миколаїв'],
            ['Київська ГЕС', 'Київ'], ['Кременчуцька ГЕС', 'Кременчук'], ['Криворізька ТЕС', 'Кривий Ріг'],
            ['Трипільська ТЕС', 'Біла Церква'], ['Запорізька АЕС', 'Запоріжжя'],
            ['Мелітополь', 'Запоріжжя'], ['Луганськ', 'Краматорськ'],
            ['Керч', 'Сімферополь'], ['Нікополь', 'Запоріжжя'], ['Біла Церква', 'Київ'], ['Кременчук', 'Полтава'],
            ['Бурштинська ТЕС', 'Івано-Франківськ'],
            ['Хмельницька АЕС', 'Рівне'],
            ['Вінниця', 'Кропивницький']
        ];

        const cityMarkers = {};
        const lineLayers = [];
        const powerStationMarkers = {};
        const cityHealth = {};
        const cityHealthMarkers = {};
        const cityDisabledLayers = {};
        let repairTeams = 3;
        let difficultyMultiplier = 1;
        let lastAttackTime = Date.now();

        const repairTimes = {
            'АЕС': 8000,
            'ТЕС': 5000,
            'ГЕС': 4000,
            'line': 2000
        };

        function showWarning(message) {
            const warning = document.createElement('div');
            warning.className = 'warning-message';
            warning.textContent = message;
            document.body.appendChild(warning);
            setTimeout(() => warning.remove(), 4000);
        }

        function updateCityHealthIndicator(cityName, show) {
            if (show) {
                if (!cityHealthMarkers[cityName]) {
                    const container = L.DomUtil.create('div', 'health-container');
                    L.DomUtil.create('div', 'health-bar', container);

                    const icon = L.divIcon({
                        className: '',
                        html: container.outerHTML,
                        iconSize: [60, 6],
                        iconAnchor: [30, 0]
                    });

                    const marker = L.marker(cities[cityName], {
                        icon,
                        zIndexOffset: 1000
                    }).addTo(map);

                    cityHealthMarkers[cityName] = {
                        marker
                    };

                    // Затримка для DOM-готовності
                    setTimeout(() => updateHealthBar(cityName, cityHealth[cityName].current), 0);
                } else {
                    cityHealthMarkers[cityName].marker.setOpacity(1);
                }
            } else if (cityHealthMarkers[cityName]) {
                cityHealthMarkers[cityName].marker.setOpacity(0);
            }
        }

        function updateHealthBar(cityName, percentage) {
            const healthMarker = cityHealthMarkers[cityName];
            if (healthMarker) {
                const el = healthMarker.marker.getElement();
                if (el) {
                    const bar = el.querySelector('.health-bar');
                    if (bar) {
                        bar.style.width = `${percentage}%`;
                    }
                }
            }
        }


        function startHealthDecrease(cityName) {
            if (cityHealth[cityName].timer) return;

            cityHealth[cityName].current = 100;
            updateHealthBar(cityName, 100);

            const decreaseInterval = 100;
            const totalTime = 60000;
            const steps = totalTime / decreaseInterval;
            const decreasePerStep = 100 / steps;

            cityHealth[cityName].timer = setInterval(() => {
                cityHealth[cityName].current = Math.max(0, cityHealth[cityName].current - decreasePerStep);
                updateHealthBar(cityName, cityHealth[cityName].current);

                if (cityHealth[cityName].current <= 0) {
                    clearInterval(cityHealth[cityName].timer);
                    cityHealth[cityName].timer = null;
                    disableCity(cityName);
                    showWarning(`${cityName} втратив всі ресурси!`);
                }
            }, decreaseInterval);
        }

        function disableCity(cityName) {
            const marker = cityMarkers[cityName];

            // Додаємо градієнтний сірий фон
            const disabledLayer = L.divIcon({
                className: 'city-disabled',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            const disabledMarker = L.marker(cities[cityName], {
                icon: disabledLayer,
                interactive: false,
                zIndexOffset: -1
            }).addTo(map);

            cityDisabledLayers[cityName] = disabledMarker;

            // Ховаємо індикатор здоров'я
            if (cityHealthMarkers[cityName]) {
                cityHealthMarkers[cityName].marker.setOpacity(0);
            }

            // Робимо основний маркер прозорим
            marker.setStyle({
                fillOpacity: 0,
                opacity: 0
            });
        }

        function enableCity(cityName) {
            const marker = cityMarkers[cityName];

            // Видаляємо сірий фон
            if (cityDisabledLayers[cityName]) {
                map.removeLayer(cityDisabledLayers[cityName]);
                delete cityDisabledLayers[cityName];
            }

            // Відновлюємо основний маркер
            marker.setStyle({
                fillOpacity: 1,
                opacity: 1
            });
        }

        function stopHealthDecrease(cityName) {
            if (cityHealth[cityName].timer) {
                clearInterval(cityHealth[cityName].timer);
                cityHealth[cityName].timer = null;
            }
        }

        function resetCityHealth(cityName) {
            cityHealth[cityName].current = 100;
            updateHealthBar(cityName, 100);
            enableCity(cityName);
        }

        for (const [name, coords] of Object.entries(cities)) {
            const marker = L.circleMarker(coords, {
                radius: 6,
                color: '#4fc3f7',
                fillColor: '#4fc3f7',
                fillOpacity: 1,
                opacity: 1
            }).addTo(map);
            marker.bindTooltip(name, { permanent: false, direction: 'top' });
            cityMarkers[name] = marker;

            cityHealth[name] = {
                current: 100,
                timer: null,
                powered: true
            };
        }

        function showProgressBar(latlng, duration, onComplete) {
            const container = L.DomUtil.create('div', 'progress-container');
            L.DomUtil.create('div', 'progress-bar', container);

            const icon = L.divIcon({
                className: '',
                html: container.outerHTML,
                iconSize: [60, 8],
                iconAnchor: [30, 0]
            });

            const marker = L.marker(latlng, { icon }).addTo(map);

            let start = null;
            function animate(timestamp) {
                if (!start) start = timestamp;
                const progress = (timestamp - start) / duration;

                const el = marker.getElement();
                if (el) {
                    const barEl = el.querySelector('.progress-bar');
                    if (barEl) {
                        barEl.style.width = `${Math.min(progress * 100, 100)}%`;
                    }
                }

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    map.removeLayer(marker);
                    onComplete();
                }
            }

            requestAnimationFrame(animate);
        }

        powerStations.forEach(({ name, coords, type }) => {
            const marker = L.circleMarker(coords, {
                radius: 10,
                color: '#43a047',
                fillColor: '#43a047',
                fillOpacity: 1,
                riseOnHover: true,
                interactive: true
            }).addTo(map);
            marker.bindTooltip(`${name} (${type})`, { permanent: false, direction: 'top' });
            powerStationMarkers[name] = { marker, fire: null, damaged: false, type };

            marker.on('click', () => repairPowerStation(name));
        });

        function repairPowerStation(name) {
            const ps = powerStationMarkers[name];
            if (!ps.damaged) return;

            if (repairTeams <= 0) {
                showWarning("Недостатньо бригад! Зачекайте, поки звільниться хоча б одна.");
                return;
            }

            repairTeams--;
            updateTeamStatus();

            showProgressBar(ps.marker.getLatLng(), repairTimes[ps.type] * difficultyMultiplier, () => {
                ps.damaged = false;
                if (ps.fire) {
                    map.removeLayer(ps.fire);
                    ps.fire = null;
                }
                ps.marker.setStyle({
                    color: '#43a047',
                    fillColor: '#43a047'
                });
                repairTeams++;
                updateTeamStatus();
                updateCityPowerStatus();
            });
        }

        function midpoint(coord1, coord2) {
            return [(coord1[0] + coord2[0]) / 2, (coord1[1] + coord2[1]) / 2];
        }

        function hasPath(graph, start, goal) {
            if (start === goal) return true;
            const visited = new Set();
            const queue = [start];
            while (queue.length) {
                const node = queue.shift();
                if (node === goal) return true;
                visited.add(node);
                for (const neighbor of (graph[node] || [])) {
                    if (!visited.has(neighbor)) queue.push(neighbor);
                }
            }
            return false;
        }

        function updateTeamStatus() {
            const teamElement = document.createElement('div');
            teamElement.id = 'teamsStatus';
            teamElement.innerHTML = `Ремонтні бригади: <span style="color:${repairTeams > 0 ? 'green' : 'red'}">${repairTeams}</span>`;

            const statusPanel = document.getElementById('statusPanel');
            const existingTeamElement = document.getElementById('teamsStatus');

            if (existingTeamElement) {
                statusPanel.replaceChild(teamElement, existingTeamElement);
            } else {
                statusPanel.appendChild(teamElement);
            }
        }

        function updateStatusPanel(poweredCities, totalCities) {
            const psStats = { 'ГЕС': [0, 0], 'АЕС': [0, 0], 'ТЕС': [0, 0] };
            for (const { name, type } of powerStations) {
                const ps = powerStationMarkers[name];
                if (ps.damaged) psStats[type][1]++;
                else psStats[type][0]++;
            }

            let workingLines = 0, damagedLines = 0;
            for (const conn of lineLayers) {
                if (conn.damaged) damagedLines++;
                else workingLines++;
            }

            const color = (good, total) => {
                const damaged = total - good;
                return `<span style="color:red;">${damaged}</span> / <span style="color:green;">${total}</span>`;
            };

            const statusHTML = `
                        <div><strong>Міста:</strong> ${color(poweredCities, totalCities)}</div>
                        <div><strong>ГЕС:</strong> ${color(psStats['ГЕС'][0], psStats['ГЕС'][0] + psStats['ГЕС'][1])}</div>
                        <div><strong>АЕС:</strong> ${color(psStats['АЕС'][0], psStats['АЕС'][0] + psStats['АЕС'][1])}</div>
                        <div><strong>ТЕС:</strong> ${color(psStats['ТЕС'][0], psStats['ТЕС'][0] + psStats['ТЕС'][1])}</div>
                        <div><strong>Лінії:</strong> ${color(workingLines, workingLines + damagedLines)}</div>
                    `;
            document.getElementById('statusPanel').innerHTML = statusHTML;
            updateTeamStatus();
        }

        function updateCityPowerStatus() {
            const workingStations = Object.entries(powerStationMarkers)
                .filter(([name, ps]) => !ps.damaged)
                .map(([name]) => name);

            const graph = {};
            Object.keys(cities).forEach(name => graph[name] = []);
            Object.keys(powerStationMarkers).forEach(name => graph[name] = []);
            for (const { from, to, damaged } of lineLayers) {
                if (!damaged) {
                    graph[from].push(to);
                    graph[to].push(from);
                }
            }

            for (const [city, marker] of Object.entries(cityMarkers)) {
                let powered = false;
                for (const station of workingStations) {
                    if (hasPath(graph, city, station)) {
                        powered = true;
                        break;
                    }
                }

                const wasPowered = cityHealth[city].powered;
                cityHealth[city].powered = powered;

                if (wasPowered !== powered) {
                    if (powered) {
                        stopHealthDecrease(city);
                        resetCityHealth(city);
                        updateCityHealthIndicator(city, false);
                        marker.setStyle({
                            fillColor: '#4fc3f7',
                            color: '#4fc3f7'
                        });
                    } else {
                        resetCityHealth(city);
                        updateCityHealthIndicator(city, true);
                        startHealthDecrease(city);
                        marker.setStyle({
                            fillColor: 'black',
                            color: 'black'
                        });
                    }
                }
            }

            const poweredCount = Object.values(cityMarkers).filter(m => m.options.fillColor !== 'black').length;
            updateStatusPanel(poweredCount, Object.keys(cityMarkers).length);
        }

        connections.forEach(([from, to]) => {
            const latlngs = [cities[from] || powerStations.find(p => p.name === from)?.coords,
            cities[to] || powerStations.find(p => p.name === to)?.coords];
            if (!latlngs[0] || !latlngs[1]) return;

            const line = L.polyline(latlngs, {
                color: 'black', weight: 2
            }).addTo(map);

            const damageMarker = L.marker(midpoint(latlngs[0], latlngs[1]), {
                icon: L.divIcon({
                    className: 'damage-icon',
                    html: '<span style="font-size:24px;line-height:24px;">⚡</span>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(map).setOpacity(0);

            const conn = { from, to, line, damaged: false, damageMarker };
            lineLayers.push(conn);

            damageMarker.on('click', () => {
                if (!conn.damaged) return;

                if (repairTeams <= 0) {
                    showWarning("Недостатньо бригад для ремонту!");
                    return;
                }

                repairTeams--;
                updateTeamStatus();

                showProgressBar(damageMarker.getLatLng(), repairTimes['line'] * difficultyMultiplier, () => {
                    conn.damaged = false;
                    conn.line.setStyle({ color: 'black' });
                    damageMarker.setOpacity(0);
                    repairTeams++;
                    updateTeamStatus();
                    updateCityPowerStatus();
                });
            });
        });

        function simulateAttack() {
            scheduleNextAttack();

            let attackSuccessful = false;

            if (Math.random() < 0.8) {
                const randomLine = lineLayers[Math.floor(Math.random() * lineLayers.length)];
                if (!randomLine.damaged) {
                    randomLine.damaged = true;
                    randomLine.line.setStyle({ color: '#e6b800' });
                    randomLine.damageMarker.setOpacity(1);
                    attackSuccessful = true;
                }
            } else {
                const names = Object.keys(powerStationMarkers);
                const name = names[Math.floor(Math.random() * names.length)];
                const ps = powerStationMarkers[name];
                if (!ps.damaged) {
                    ps.damaged = true;
                    if (ps.fire) map.removeLayer(ps.fire);
                    ps.fire = L.marker(ps.marker.getLatLng(), {
                        icon: L.divIcon({
                            className: 'fire-icon',
                            html: '<span style="font-size:20px;line-height:20px;">🔥</span>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 20]
                        })
                    }).addTo(map);
                    ps.fire.on('click', () => repairPowerStation(name));
                    ps.marker.setStyle({
                        color: '#e57373',
                        fillColor: '#e57373'
                    });
                    attackSuccessful = true;
                }
            }

            if (attackSuccessful) {
                if (Math.random() < 0.3) difficultyMultiplier = Math.min(2, difficultyMultiplier * 1.05);
                updateCityPowerStatus();
                console.log(`Attack! Difficulty: ${difficultyMultiplier.toFixed(2)}`);
            }
        }

        function scheduleNextAttack() {
            const now = Date.now();
            const timeSinceLast = now - lastAttackTime;

            const dynamicDelay = Math.min(15000, Math.max(3000, 3000 + timeSinceLast * 0.5));

            setTimeout(() => {
                simulateAttack();
                lastAttackTime = Date.now();
            }, dynamicDelay);
        }

        scheduleNextAttack();
        updateCityPowerStatus();
    </script>
</body>
</html>